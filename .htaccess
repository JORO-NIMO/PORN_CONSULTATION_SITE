# Apache Configuration for Freedom Path Platform

# Enable Rewrite Engine
RewriteEngine On

# Force HTTPS (uncomment in production)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Prevent directory listing and follow symlinks
Options -Indexes +FollowSymLinks

# Protect sensitive files and directories
<FilesMatch "^\.|composer\.(json|lock)|package(-lock)?\.json|yarn\.lock|webpack\.config\.js|Dockerfile|docker-compose\.ya?ml|README\.md|CHANGELOG\.md|UPGRADE\.md|LICENSE|LICENSE\..*|phpunit\.xml\.dist|phpunit\.xml|phpcs\.xml|phpmd\.xml|psalm\.xml|phpstan\.neon|phpstan-baseline\.neon|phpstan-baseline\.neon\.dist|behat\.yml|behat\.yaml|appveyor\.yml|travis\.yml|phpcs\.xml\.dist|phpmd\.xml\.dist|psalm\.xml\.dist|phpstan\.neon\.dist|phpstan-baseline\.neon\.dist$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# Security Headers
<IfModule mod_headers.c>
    # Security Headers
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy
    Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://*.x.com; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.x.com; frame-ancestors 'none'; form-action 'self'; base-uri 'self';"
    
    # Prevent MIME type sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # Block pages from loading when they detect reflected XSS attacks
    Header set X-XSS-Protection "1; mode=block"
    
    # Enable XSS filter for older browsers
    <IfModule mod_setenvif.c>
        <IfModule mod_headers.c>
            BrowserMatch \bMSIE\s8 ie8
            Header set X-XSS-Protection: "1; mode=block" env=!ie8
        </IfModule>
    </IfModule>
    
    # Set Permissions Policy
    Header set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
    
    # Set Feature Policy
    Header set Feature-Policy "geolocation 'none'; microphone 'none'; camera 'none'; payment 'none'"
    
    # Set X-Permitted-Cross-Domain-Policies
    Header set X-Permitted-Cross-Domain-Policies "none"
    
    # Set X-Download-Options
    Header set X-Download-Options "noopen"
    
    # Set X-Content-Type-Options
    Header set X-Content-Type-Options "nosniff"
</IfModule>

# PHP Settings
<IfModule mod_php7.c>
    # File upload settings
    php_value upload_max_filesize 10M
    php_value post_max_size 12M
    php_value memory_limit 128M
    
    # Error handling
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log /path/to/php_error.log
    
    # Session security
    php_flag session.cookie_httponly on
    php_flag session.cookie_secure on
    php_flag session.use_strict_mode on
    php_flag session.use_only_cookies on
    php_flag session.use_trans_sid off
    php_flag session.cookie_samesite "Strict"
    
    # Security flags
    php_flag zlib.output_compression On
    php_flag magic_quotes_gpc Off
    php_flag register_globals Off
    php_flag allow_url_fopen Off
    php_flag allow_url_include Off
    php_flag expose_php Off
</IfModule>

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    
    # Remove browser bugs (only needed for really old browsers)
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
</IfModule>

# Browser Caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 month"
    
    # CSS, JavaScript
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    
    # Media files
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # Web fonts
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
    ExpiresByType application/x-font-ttf "access plus 1 year"
    ExpiresByType font/opentype "access plus 1 year"
    
    # HTML components (HTCs)
    ExpiresByType text/x-component "access plus 1 month"
    
    # HTML
    ExpiresByType text/html "access plus 0 seconds"
    
    # XML
    ExpiresByType application/xml "access plus 0 seconds"
    ExpiresByType text/xml "access plus 0 seconds"
    
    # Manifest files
    ExpiresByType application/manifest+json "access plus 1 week"
    ExpiresByType application/x-web-app-manifest+json "access plus 0 seconds"
    ExpiresByType text/cache-manifest "access plus 0 seconds"
    
    # Data interchange
    ExpiresByType application/json "access plus 0 seconds"
    
    # Favicon
    ExpiresByType image/x-icon "access plus 1 week"
    
    # Media: images, video, audio
    ExpiresByType video/ogg "access plus 1 month"
    ExpiresByType audio/ogg "access plus 1 month"
    ExpiresByType video/mp4 "access plus 1 month"
    ExpiresByType video/webm "access plus 1 month"
    
    # Web feeds
    ExpiresByType application/atom+xml "access plus 1 hour"
    ExpiresByType application/rss+xml "access plus 1 hour"
</IfModule>

# Block access to sensitive directories
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Block access to all hidden files and directories except for the .well-known directory
    RewriteCond %{REQUEST_URI} "^/\.(?!well-known/).*" [NC]
    RewriteRule .* - [F]
    
    # Block access to specific directories
    RewriteRule ^(config|vendor|tests|node_modules|\.git|\.github|\.vscode|\.idea)/ - [F,L,NC]
    
    # Block access to specific file types
    <FilesMatch "\.(env|log|sql|tpl|twig|md|sh|bat|cmd|php[0-9]?|phtml|phps|pht|phar|s?html?|pl|py|jsp|asp|sh|cgi|htaccess|htpasswd|ini|psd|log|error_log|access_log|gitignore|gitmodules|gitkeep|gitattributes|git|svn|DS_Store|DS_Store?|_DS_Store|\.AppleDouble|\.LSOverride|\.Spotlight-V100|\.Trashes|ehthumbs\.db|Thumbs\.db|composer\.(json|lock)|package(-lock)?\.json|yarn\.lock|webpack\.config\.js|Dockerfile|docker-compose\.ya?ml|README\.md|CHANGELOG\.md|UPGRADE\.md|LICENSE|LICENSE\..*|phpunit\.xml\.dist|phpunit\.xml|phpcs\.xml|phpmd\.xml|psalm\.xml|phpstan\.neon|phpstan-baseline\.neon|phpstan-baseline\.neon\.dist|phpunit\.xml|phpunit\.xml\.dist|behat\.yml|behat\.yaml|appveyor\.yml|travis\.yml|phpcs\.xml\.dist|phpmd\.xml\.dist|psalm\.xml\.dist|phpstan\.neon\.dist|phpstan-baseline\.neon\.dist|phpunit\.xml\.dist|behat\.yml\.dist|behat\.yaml\.dist|appveyor\.yml\.dist|travis\.yml\.dist|phpcs\.xml\.dist|phpmd\.xml\.dist|psalm\.xml\.dist|phpstan\.neon\.dist|phpstan-baseline\.neon\.dist)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
    </FilesMatch>
</IfModule>

# Enable Keep-Alive
<IfModule mod_headers.c>
    Header set Connection keep-alive
</IfModule>

# Set the default handler
DirectoryIndex index.php index.html index.htm

# Error Pages
ErrorDocument 400 /error.php?code=400
ErrorDocument 401 /error.php?code=401
ErrorDocument 403 /error.php?code=403
ErrorDocument 404 /error.php?code=404
ErrorDocument 500 /error.php?code=500
ErrorDocument 502 /error.php?code=502
ErrorDocument 503 /error.php?code=503
ErrorDocument 504 /error.php?code=504

# Disable server signature
ServerSignature Off

# Disable ETags
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>
FileETag None

# Set default charset
AddDefaultCharset UTF-8
